<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ theme }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ stream.title }} - StreamLite</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: {% if theme == 'dark' %}#000{% else %}#f8f9fa{% endif %};
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .embed-container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        
        .video-container {
            position: relative;
            flex: 1;
            background-color: #000;
            min-height: 65%;
        }
        
        .video-container iframe,
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Chat container */
        .chat-container {
            width: 300px;
            background-color: {% if theme == 'dark' %}#1a1a1a{% else %}#f8f9fa{% endif %};
            border-left: 1px solid {% if theme == 'dark' %}#2d2d2d{% else %}#dee2e6{% endif %};
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* Chat messages area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        /* Chat form area */
        .chat-form {
            border-top: 1px solid {{ theme == 'dark' ? '#2d2d2d' : '#dee2e6' }};
            padding: 0.75rem;
        }
        
        /* Chat message styling */
        .chat-message {
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .username {
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .timestamp {
            font-size: 0.75rem;
            opacity: 0.7;
        }
        
        .system-message {
            font-style: italic;
            opacity: 0.8;
            text-align: center;
            padding: 0.5rem;
            margin: 0.5rem 0;
            background-color: {{ theme == 'dark' ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.05)' }};
            border-radius: 0.25rem;
        }
        
        .stream-info {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            padding: 0.5rem 1rem;
            background-color: {{ theme == 'dark' ? 'rgba(0, 0, 0, 0.7)' : 'rgba(255, 255, 255, 0.7)' }};
            border-radius: 0.25rem;
            color: {{ theme == 'dark' ? '#fff' : '#212529' }};
            z-index: 100;
            max-width: 50%;
            backdrop-filter: blur(5px);
        }
        
        .stream-info h3 {
            margin: 0;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .stream-info p {
            margin: 0.25rem 0 0;
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .stream-info img {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .viewer-count {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.5rem;
            background-color: {{ theme == 'dark' ? 'rgba(220, 53, 69, 0.8)' : 'rgba(220, 53, 69, 0.9)' }};
            border-radius: 0.25rem;
            color: #fff;
            font-size: 0.85rem;
            z-index: 100;
            display: flex;
            align-items: center;
        }
        
        .viewer-count i {
            margin-right: 0.25rem;
        }

        .stream-offline {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: {{ theme == 'dark' ? '#fff' : '#212529' }};
        }
        
        .watermark {
            position: absolute;
            top: 1rem;
            left: 1rem;
            padding: 0.25rem 0.5rem;
            background-color: {{ theme == 'dark' ? 'rgba(0, 0, 0, 0.5)' : 'rgba(255, 255, 255, 0.5)' }};
            border-radius: 0.25rem;
            color: {{ theme == 'dark' ? '#fff' : '#212529' }};
            font-size: 0.75rem;
            z-index: 100;
        }
        
        .watermark a {
            color: {{ theme == 'dark' ? '#fff' : '#212529' }};
            text-decoration: none;
        }
        
        /* Chat header */
        .chat-header {
            padding: 0.75rem;
            border-bottom: 1px solid {{ theme == 'dark' ? '#2d2d2d' : '#dee2e6' }};
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #14a44d;
            margin-right: 0.5rem;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .embed-container {
                flex-direction: column;
            }
            
            .video-container {
                height: 60vh;
            }
            
            .chat-container {
                width: 100%;
                height: 40vh;
                border-left: none;
                border-top: 1px solid {{ theme == 'dark' ? '#2d2d2d' : '#dee2e6' }};
            }
        }
        
        /* Stream retry message */
        #stream-retry-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            max-width: 80%;
            text-align: center;
            z-index: 200;
            display: none;
        }
    </style>
</head>
<body>
    <div class="embed-container">
        <div class="video-container">
            {% if stream.is_live %}
            <video id="stream-player" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" data-setup='{"fluid": true, "liveui": true, "html5": {"hls": {"overrideNative": false}}, "techOrder": ["html5"], "autoplay": true, "liveTracker": {"trackingThreshold": 0.5, "liveTolerance": 30}}'>
                <!-- Primary HLS source (HTTPS) -->
                <source src="https://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8" type="application/x-mpegURL">
                <!-- HTTP fallback if needed -->
                <source src="http://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8" type="application/x-mpegURL">
                <!-- MP4 fallback for direct playback compatibility -->
                <source src="https://hwosecurity.org/live/hls/{{ stream.stream_key }}.mp4" type="video/mp4">
                <!-- Fallback message -->
                <p class="vjs-no-js">
                    To view this video please enable JavaScript, and consider upgrading to a web browser that
                    <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
                </p>
            </video>
            
            <!-- Alternative formats for different clients (hidden from UI but accessible via links) -->
            <div id="format-links" style="display: none;">
                <!-- HLS links -->
                <a id="hls-link" href="https://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8">HLS Stream</a>
                <!-- DASH link -->
                <a id="dash-link" href="https://hwosecurity.org/live/dash/{{ stream.stream_key }}.mpd">DASH Stream</a>
                <!-- Direct MP4 link -->
                <a id="direct-link" href="https://hwosecurity.org/live/hls/{{ stream.stream_key }}.mp4">Direct MP4</a>
                <!-- RTMP link for OBS and similar software -->
                <a id="rtmp-link" href="rtmp://hwosecurity.org/live/{{ stream.stream_key }}">RTMP Stream</a>
                <!-- RTMPS link (Secure RTMP) -->
                <a id="rtmps-link" href="rtmps://hwosecurity.org/live/{{ stream.stream_key }}">RTMPS Stream</a>
                <!-- WebRTC link -->
                <a id="webrtc-link" href="https://hwosecurity.org/webrtc/view/{{ stream.stream_key }}">WebRTC Stream</a>
            </div>
            
            <!-- Error message container -->
            <div id="stream-error-container" style="display: none;">
                <div id="stream-retry-message" class="alert alert-info">
                    <i class="fas fa-sync-alt fa-spin me-2"></i> Connecting to stream... If the stream doesn't appear in 10 seconds, <a href="#" id="retry-stream-btn" class="alert-link text-white">click here to retry</a>.
                </div>
                <div id="stream-format-error" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i> The media could not be loaded, either because the server or network failed or because the format is not supported. <a href="#" id="format-retry-btn" class="alert-link text-white">Click here to try again</a>.
                </div>
                <div id="stream-network-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-wifi-slash me-2"></i> Network error detected. Please check your internet connection. <a href="#" id="network-retry-btn" class="alert-link text-white">Click here to retry</a>.
                </div>
            </div>
            
            <!-- Format selection dropdown for direct user selection -->
            <div class="format-selection" style="position: absolute; top: 10px; right: 80px; z-index: 100;">
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" id="formatDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog"></i> Format
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="formatDropdown">
                        <li><a class="dropdown-item" href="#" id="select-hls">HLS (Web/iOS)</a></li>
                        <li><a class="dropdown-item" href="#" id="select-dash">DASH (Android/Chrome)</a></li>
                        <li><a class="dropdown-item" href="#" id="select-mp4">Direct MP4</a></li>
                        <li><a class="dropdown-item" href="#" id="select-webrtc">WebRTC (Low Latency)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="vlc://https://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8">Open in VLC</a></li>
                        <li><a class="dropdown-item" href="#" onclick="copyToClipboard('https://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8')">Copy HLS URL</a></li>
                        <li><a class="dropdown-item" href="#" onclick="copyToClipboard('rtmp://hwosecurity.org/live/{{ stream.stream_key }}')">Copy RTMP URL</a></li>
                    </ul>
                </div>
            </div>
            {% if show_viewers %}
            <div class="viewer-count">
                <i class="fas fa-eye"></i> <span id="viewerCount">{{ stream.viewer_count }}</span>
            </div>
            {% endif %}
            {% else %}
            <div class="stream-offline">
                <i class="fas fa-video-slash fa-3x mb-3"></i>
                <h3>Stream Offline</h3>
                <p>This stream is currently offline. Please check back later.</p>
            </div>
            {% endif %}
            
            {% if show_info %}
            <div class="stream-info">
                <div class="d-flex align-items-center">
                    <div>
                        {% if streamer.profile_image %}
                        <img src="{{ streamer.profile_image }}" alt="{{ streamer.username }}">
                        {% else %}
                        <span class="avatar-placeholder">{{ streamer.username[0] }}</span>
                        {% endif %}
                    </div>
                    <div>
                        <h3>{{ stream.title }}</h3>
                        <p>{{ streamer.username }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if show_watermark %}
            <div class="watermark">
                <a href="{{ url_for('live.view_stream', stream_id=stream.id, _external=True) }}" target="_blank">
                    <i class="fas fa-external-link-alt"></i> StreamLite
                </a>
            </div>
            {% endif %}
        </div>
        
        <!-- Chat Container -->
        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <i class="fas fa-comments me-1"></i> Live Chat
                </div>
                <div>
                    <span class="online-indicator"></span>
                    <span id="online-users">0</span> online
                </div>
            </div>
            <div class="chat-messages" id="chat-messages">
                {% if stream.is_live %}
                <div class="text-center p-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading chat messages...</p>
                </div>
                {% else %}
                <div class="text-center text-muted p-3">
                    <i class="fas fa-comments fa-2x mb-2"></i>
                    <p>Chat is offline</p>
                    <p>Chat will be available when the stream goes live</p>
                </div>
                {% endif %}
            </div>
            <div class="chat-form">
                {% if stream.is_live %}
                <form id="chat-form" class="d-flex">
                    <input type="text" id="chat-input" class="form-control me-2" placeholder="Send a message...">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                <div id="login-prompt" class="mt-2 text-center" style="display: none;">
                    <a href="{{ url_for('auth.login', next=url_for('live.view_stream', stream_id=stream.id), _external=True) }}" target="_blank" class="btn btn-sm btn-outline-primary">Login to chat</a>
                </div>
                {% else %}
                <form id="chat-form" class="d-flex">
                    <input type="text" id="chat-input" class="form-control me-2" placeholder="Chat is offline..." disabled>
                    <button type="submit" class="btn btn-primary" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    {% if stream.is_live %}
    <script>
        let isLoggedIn = false;
        let lastMessageId = 0;
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const loginPrompt = document.getElementById('login-prompt');
        
        // Check if user is logged in
        fetch('{{ url_for("auth.check_login_status") }}', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            isLoggedIn = data.is_authenticated;
            if (!isLoggedIn) {
                chatInput.disabled = true;
                chatInput.placeholder = "Login to join the chat";
                loginPrompt.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error checking login status:', error);
        });
        
        // Function to add a chat message
        function addChatMessage(message) {
            // Remove loading spinner if present
            if (chatMessages.querySelector('.spinner-border')) {
                chatMessages.innerHTML = '';
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            if (message.is_system) {
                messageElement.className += ' system-message';
                messageElement.textContent = message.message;
            } else {
                messageElement.innerHTML = `
                    <div class="message-header">
                        <span class="username">${message.username}</span>
                        <span class="timestamp">${message.timestamp}</span>
                    </div>
                    <div>${message.message}</div>
                `;
            }
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lastMessageId = message.id;
        }
        
        // Fetch chat messages
        async function getMessages() {
            try {
                const response = await fetch(`{{ url_for('live.get_chat', stream_id=stream.id) }}?last_id=${lastMessageId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.messages.length > 0) {
                        data.messages.forEach(message => {
                            addChatMessage(message);
                        });
                    } else if (lastMessageId === 0 && chatMessages.querySelector('.spinner-border')) {
                        // If no messages and we're still showing the loading spinner, show empty state
                        chatMessages.innerHTML = `
                            <div class="text-center text-muted p-3">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <p>No messages yet</p>
                                <p>Be the first to say something!</p>
                            </div>
                        `;
                    }
                    
                    // Update online users count
                    if (data.online_users) {
                        document.getElementById('online-users').textContent = data.online_users;
                    }
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }
        
        // Send chat message
        if (chatForm) {
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!isLoggedIn) {
                    alert('Please login to send messages');
                    return;
                }
                
                const message = chatInput.value.trim();
                if (!message) return;
                
                try {
                    const response = await fetch(`{{ url_for('live.post_chat', stream_id=stream.id) }}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message }),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        addChatMessage(data);
                        chatInput.value = '';
                    } else if (response.status === 401) {
                        // Unauthorized - user not logged in
                        isLoggedIn = false;
                        chatInput.disabled = true;
                        chatInput.placeholder = "Login to join the chat";
                        loginPrompt.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            });
        }
        
        // Set up polling for messages
        setInterval(getMessages, 3000);
        
        // Initial message fetch
        getMessages();
        
        {% if show_viewers %}
        // Update viewer count every 30 seconds
        function updateViewerCount() {
            fetch('{{ url_for("live.get_viewers", stream_id=stream.id) }}')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('viewerCount').textContent = data.viewer_count;
                });
        }
        
        setInterval(updateViewerCount, 30000);
        {% endif %}
        
        // Function to copy URL to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            // Show a temporary tooltip/alert
            alert('URL copied to clipboard: ' + text);
        }
        
        // Initialize video.js player with improved error handling
        const player = videojs('stream-player', {
            liveui: true,
            html5: { hls: { overrideNative: false } },
            autoplay: true,
            preload: 'auto',
            loadingSpinner: true,
            errorDisplay: true,
            responsive: true,
            fluid: true,
            controlBar: {
                playToggle: false,
                currentTimeDisplay: false,
                timeDivider: false,
                durationDisplay: false,
                progressControl: false,
                liveDisplay: true,
                fullscreenToggle: true,
                volumePanel: true,
                pictureInPictureToggle: true
            }
        });
        
        // Format selection handlers
        document.getElementById('select-hls').addEventListener('click', function(e) {
            e.preventDefault();
            player.src({
                src: 'https://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8',
                type: 'application/x-mpegURL'
            });
            player.play();
        });
        
        document.getElementById('select-dash').addEventListener('click', function(e) {
            e.preventDefault();
            player.src({
                src: 'https://hwosecurity.org/live/dash/{{ stream.stream_key }}.mpd',
                type: 'application/dash+xml'
            });
            player.play();
        });
        
        document.getElementById('select-mp4').addEventListener('click', function(e) {
            e.preventDefault();
            player.src({
                src: 'https://hwosecurity.org/live/hls/{{ stream.stream_key }}.mp4',
                type: 'video/mp4'
            });
            player.play();
        });
        
        document.getElementById('select-webrtc').addEventListener('click', function(e) {
            e.preventDefault();
            // Open WebRTC view in a new window/tab
            window.open('https://hwosecurity.org/webrtc/view/{{ stream.stream_key }}', '_blank');
        });
        
        // Show retry message after 5 seconds if still loading
        setTimeout(function() {
            if (player.readyState() < 1) {
                document.getElementById('stream-retry-message').style.display = 'block';
            }
        }, 5000);
        
        // Handle retry button click
        document.getElementById('retry-stream-btn').addEventListener('click', function(e) {
            e.preventDefault();
            player.reset();
            player.src([
                {src: 'https://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8', type: 'application/x-mpegURL'},
                {src: 'http://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8', type: 'application/x-mpegURL'}
            ]);
            player.load();
            player.play();
            
            // Also check stream status
            fetch('{{ url_for("live.check_stream_status", stream_id=stream.id) }}')
                .then(response => response.json())
                .then(data => {
                    if (!data.is_live) {
                        // If server says not live but we're still trying to load
                        // Refresh the page to update status
                        location.reload();
                    }
                });
        });
        
        // Handle player events
        player.on('play', function() {
            console.log('Video playback started');
            document.getElementById('stream-retry-message').style.display = 'none';
        });
        
        player.on('error', function(e) {
            console.log('Video playback error', e);
            document.getElementById('stream-retry-message').style.display = 'block';
            
            // Try to recover automatically
            setTimeout(function() {
                player.reset();
                player.src([
                    {src: 'http://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8', type: 'application/x-mpegURL'},
                    {src: 'https://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8', type: 'application/x-mpegURL'}
                ]);
                player.load();
                player.play();
            }, 3000);
        });
        
        // Use Hls.js if available for better compatibility
        if (window.Hls && Hls.isSupported() && !player.canPlayType('application/vnd.apple.mpegurl')) {
            const hls = new Hls({
                debug: false,
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 90,
                maxBufferLength: 30,
                maxMaxBufferLength: 600,
                maxBufferSize: 60 * 1000 * 1000, // 60MB
                maxBufferHole: 0.5,
                highBufferWatchdogPeriod: 2,
                nudgeMaxRetry: 5
            });
            
            const videoElement = document.getElementById('stream-player_html5_api');
            hls.loadSource('https://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8');
            hls.attachMedia(videoElement);
            
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                videoElement.play();
                document.getElementById('stream-retry-message').style.display = 'none';
            });
            
            hls.on(Hls.Events.ERROR, function(event, data) {
                console.log('HLS.js error:', data);
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log('Network error, trying HTTP fallback');
                            hls.loadSource('http://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8');
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log('Media error, trying to recover');
                            hls.recoverMediaError();
                            break;
                        default:
                            console.log('Fatal error, reloading player');
                            document.getElementById('stream-retry-message').style.display = 'block';
                            hls.destroy();
                            
                            // Create new HLS instance
                            setTimeout(function() {
                                const newHls = new Hls();
                                newHls.loadSource('http://hwosecurity.org/live/hls/{{ stream.stream_key }}.m3u8');
                                newHls.attachMedia(videoElement);
                                newHls.on(Hls.Events.MANIFEST_PARSED, function() {
                                    videoElement.play();
                                });
                            }, 2000);
                            break;
                    }
                }
            });
        }
    </script>
    {% endif %}
</body>
</html>